# 04. Dependency Injection - ì˜ì¡´ì„± ì£¼ì…

ASP.NET Coreì˜ ë‚´ì¥ DI ì»¨í…Œì´ë„ˆì™€ ìƒëª…ì£¼ê¸° ê´€ë¦¬ë¥¼ ì´í•´í•©ë‹ˆë‹¤.

---

## ì´ ì„¹ì…˜ì—ì„œ ë‹¤ë£¨ëŠ” ë‚´ìš©

| ë¬¸ì„œ | ì„¤ëª… | ê¹Šì´ |
|------|------|------|
| [fundamentals.md](./fundamentals.md) | DI ê¸°ì´ˆ ê°œë…ê³¼ ì‚¬ìš©ë²• | í‘œë©´ |
| [lifetimes.md](./lifetimes.md) | Singleton, Scoped, Transient ìƒëª…ì£¼ê¸° | ì¤‘ê°„ |
| [internals.md](./internals.md) | DI ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ë™ì‘ | ê¹ŠìŒ |
| [advanced-patterns.md](./advanced-patterns.md) | ê³ ê¸‰ DI íŒ¨í„´ | ì‹¤ìš© |

---

## í•µì‹¬ ìš”ì•½

### ì˜ì¡´ì„± ì£¼ì…ì´ë€?

ì˜ì¡´ì„± ì£¼ì…(DI)ì€ ê°ì²´ê°€ ìì‹ ì˜ ì˜ì¡´ì„±ì„ ì§ì ‘ ìƒì„±í•˜ì§€ ì•Šê³ , ì™¸ë¶€ì—ì„œ ì£¼ì…ë°›ëŠ” ë””ìì¸ íŒ¨í„´ì…ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì˜ì¡´ì„± ì£¼ì… ë¹„êµ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  âŒ ê°•í•œ ê²°í•© (ì§ì ‘ ìƒì„±)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  public class OrderService                                 â”‚ â”‚
â”‚  â”‚  {                                                         â”‚ â”‚
â”‚  â”‚      private readonly SqlRepository _repo = new();  // ğŸ’€  â”‚ â”‚
â”‚  â”‚  }                                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  âœ… ëŠìŠ¨í•œ ê²°í•© (ì£¼ì…)                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  public class OrderService                                 â”‚ â”‚
â”‚  â”‚  {                                                         â”‚ â”‚
â”‚  â”‚      private readonly IRepository _repo;                   â”‚ â”‚
â”‚  â”‚      public OrderService(IRepository repo) => _repo = repo;â”‚ â”‚
â”‚  â”‚  }                                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DIì˜ ì¥ì 

| ì¥ì  | ì„¤ëª… |
|------|------|
| í…ŒìŠ¤íŠ¸ ìš©ì´ | Mock ê°ì²´ ì£¼ì… ê°€ëŠ¥ |
| ëŠìŠ¨í•œ ê²°í•© | ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ í”„ë¡œê·¸ë˜ë° |
| ìƒëª…ì£¼ê¸° ê´€ë¦¬ | ì»¨í…Œì´ë„ˆê°€ ê°ì²´ ìˆ˜ëª… ê´€ë¦¬ |
| ì½”ë“œ ì¬ì‚¬ìš© | ì˜ì¡´ì„± êµì²´ ìš©ì´ |
| ê´€ì‹¬ì‚¬ ë¶„ë¦¬ | ê°ì²´ ìƒì„±ê³¼ ì‚¬ìš© ë¶„ë¦¬ |

---

## ê¸°ë³¸ ì‚¬ìš©ë²•

### ì„œë¹„ìŠ¤ ë“±ë¡

```csharp
var builder = WebApplication.CreateBuilder(args);

// ì„œë¹„ìŠ¤ ë“±ë¡
builder.Services.AddTransient<IEmailService, EmailService>();
builder.Services.AddScoped<IOrderService, OrderService>();
builder.Services.AddSingleton<ICacheService, CacheService>();

// ì¸í„°í˜ì´ìŠ¤ ì—†ì´ ë“±ë¡
builder.Services.AddScoped<MyService>();

var app = builder.Build();
```

### ì„œë¹„ìŠ¤ ì£¼ì…

```csharp
// 1. ìƒì„±ì ì£¼ì… (ê¶Œì¥)
public class OrderController : ControllerBase
{
    private readonly IOrderService _orderService;

    public OrderController(IOrderService orderService)
    {
        _orderService = orderService;
    }
}

// 2. Minimal APIì—ì„œ ì£¼ì…
app.MapGet("/orders", (IOrderService service) =>
{
    return service.GetOrders();
});

// 3. [FromServices] ì†ì„±
[HttpGet]
public IActionResult Get([FromServices] IOrderService service)
{
    return Ok(service.GetOrders());
}
```

---

## ìƒëª…ì£¼ê¸° (Lifetime)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì„œë¹„ìŠ¤ ìƒëª…ì£¼ê¸°                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Singleton: ì•± ì „ì²´ì—ì„œ í•˜ë‚˜ì˜ ì¸ìŠ¤í„´ìŠ¤                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Request 1  â”€â”¬â”€â–º  Instance A                              â”‚ â”‚
â”‚  â”‚  Request 2  â”€â”¤                                             â”‚ â”‚
â”‚  â”‚  Request 3  â”€â”˜                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  Scoped: ìš”ì²­(HTTP Request)ë§ˆë‹¤ ìƒˆ ì¸ìŠ¤í„´ìŠ¤                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Request 1  â”€â”€â”€â”€â–º  Instance A                              â”‚ â”‚
â”‚  â”‚  Request 2  â”€â”€â”€â”€â–º  Instance B                              â”‚ â”‚
â”‚  â”‚  Request 3  â”€â”€â”€â”€â–º  Instance C                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  Transient: ì£¼ì…í•  ë•Œë§ˆë‹¤ ìƒˆ ì¸ìŠ¤í„´ìŠ¤                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Request 1  â”€â”€â”€â”¬â–º  Instance A (Controller)                 â”‚ â”‚
â”‚  â”‚               â””â–º  Instance B (Service)                     â”‚ â”‚
â”‚  â”‚  Request 2  â”€â”€â”€â”¬â–º  Instance C                              â”‚ â”‚
â”‚  â”‚               â””â–º  Instance D                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì–¸ì œ ì–´ë–¤ ìƒëª…ì£¼ê¸°ë¥¼ ì‚¬ìš©í• ê¹Œ?

| ìƒëª…ì£¼ê¸° | ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ | ì˜ˆì‹œ |
|----------|--------------|------|
| **Singleton** | ìƒíƒœ ì—†ìŒ, ìŠ¤ë ˆë“œ ì•ˆì „, ë¹„ìš© í° ì´ˆê¸°í™” | ìºì‹œ, ë¡œê±°, ì„¤ì • |
| **Scoped** | ìš”ì²­ë³„ ìƒíƒœ, DB ì»¨í…ìŠ¤íŠ¸ | DbContext, í˜„ì¬ ì‚¬ìš©ì |
| **Transient** | ê²½ëŸ‰, ìƒíƒœ ì—†ìŒ, ì§§ì€ ìˆ˜ëª… | ê²€ì¦ê¸°, ìœ í‹¸ë¦¬í‹° |

---

## ì£¼ì˜ì‚¬í•­

### Captive Dependency (í¬íšëœ ì˜ì¡´ì„±)

```csharp
// âŒ ì˜ëª»ëœ ì˜ˆ: Singletonì´ Scopedë¥¼ ì£¼ì…ë°›ìŒ
builder.Services.AddSingleton<SingletonService>();  // Singleton
builder.Services.AddScoped<ScopedService>();        // Scoped

public class SingletonService
{
    private readonly ScopedService _scoped;  // ğŸ’€ í¬íšë¨!

    public SingletonService(ScopedService scoped)
    {
        _scoped = scoped;  // ì²« ë²ˆì§¸ ìš”ì²­ì˜ Scopedê°€ ì˜ì›íˆ ìœ ì§€ë¨
    }
}

// âœ… ì˜¬ë°”ë¥¸ ë°©ë²•: íŒ©í† ë¦¬ ì‚¬ìš©
public class SingletonService
{
    private readonly IServiceScopeFactory _scopeFactory;

    public SingletonService(IServiceScopeFactory scopeFactory)
    {
        _scopeFactory = scopeFactory;
    }

    public void DoWork()
    {
        using var scope = _scopeFactory.CreateScope();
        var scoped = scope.ServiceProvider.GetRequiredService<ScopedService>();
        scoped.Process();
    }
}
```

### ì˜¬ë°”ë¥¸ ìƒëª…ì£¼ê¸° ê·œì¹™

```
Singletonì€ Singletonë§Œ ì£¼ì…ë°›ì„ ìˆ˜ ìˆìŒ
ScopedëŠ” Singleton, Scopedë¥¼ ì£¼ì…ë°›ì„ ìˆ˜ ìˆìŒ
TransientëŠ” ëª¨ë“  ìƒëª…ì£¼ê¸°ë¥¼ ì£¼ì…ë°›ì„ ìˆ˜ ìˆìŒ

Singleton â†’ Singleton âœ…
Singleton â†’ Scoped   âŒ (Captive Dependency!)
Singleton â†’ Transient âš ï¸ (ê°€ëŠ¥í•˜ì§€ë§Œ ì£¼ì˜)
Scoped    â†’ Singleton âœ…
Scoped    â†’ Scoped    âœ…
Scoped    â†’ Transient âœ…
```

---

## ë©´ì ‘ ë¹ˆì¶œ ì§ˆë¬¸

1. **Singleton, Scoped, Transientì˜ ì°¨ì´ì ì€?**
2. **Captive Dependency ë¬¸ì œë€?**
3. **IServiceProvider vs IServiceScopeFactory ì°¨ì´ëŠ”?**
4. **Multiple êµ¬í˜„ì„ ë“±ë¡í•˜ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?**
5. **Keyed Servicesë€?**

---

## ë‹¤ìŒ ë‹¨ê³„

â†’ [05. MVC & Minimal APIs](../05-mvc-minimal-apis/) - ì›¹ API ê°œë°œ
